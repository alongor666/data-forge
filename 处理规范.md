# 数据预处理器脚本规范

## 📋 概述

本文档详细说明数据预处理器脚本的使用规范，包括输出要求、字段映射表和计算方法。


---

## 🎯 核心功能

### 主要特性
- **字段命名标准化**: 统一使用新的字段命名规范
- **绝对值字段处理**: 支持9个绝对值字段的完整转换
- **实时计算机制**: 移除率值字段，建立动态计算体系
- **单位标准化**: 统一金额单位（万元→元）
- **数据架构优化**: 17个筛选维度 + 9个绝对值字段
- **动态数据管理**: 自动发现和管理数据结构
- **质量检查验证**: 完整的数据质量检查和验证
- **按年度分类存储**: YYYY保单第WW周变动成本明细表.csv

### 技术规范
- **数据架构**: 17个筛选维度 + 9个绝对值字段 + 实时计算机制
- **字段命名**: 统一使用新的标准命名（signed_premium_yuan等）
- **单位标准**: 所有金额字段统一为"元"单位
- **计算原则**: 先聚合绝对值，再计算比率
- **输出目标**: 直接保存到仪表板项目data目录

---

## 📁 输出要求

### 输出目录结构
```
car-insurance-dashboard/data/
├── YYYY保单第WW周变动成本明细表.csv    # 主数据文件（按年度分类）
├── data_restructure_report.json        # 处理报告
└── metadata/                           # 元数据目录
    ├── available_years.json            # 可用年度信息
    ├── available_weeks.json            # 周次映射信息
    └── data_catalog.json               # 数据目录信息
```

### 核心输出文件

#### 1. 主数据文件
- **命名格式**: `YYYY保单第WW周变动成本明细表.csv`
- **编码格式**: UTF-8 with BOM
- **数据结构**: 17个筛选维度字段 + 9个绝对值字段 + week_number字段
- **自动分类**: 按保险起期年度自动分类存储

#### 2. 处理报告 (data_restructure_report.json)
```json
{
  "processing_summary": {
    "total_files": "处理的文件总数",
    "successful": "成功处理的文件数",
    "failed": "处理失败的文件数",
    "years_processed": ["涉及的年度列表"]
  },
  "processed_files": ["详细的文件处理信息"],
  "year_statistics": {"按年度分类的文件统计"},
  "errors": ["处理过程中的错误信息"]
}
```

#### 3. 元数据文件
- **available_years.json**: 记录所有可用年度及更新时间
- **available_weeks.json**: 记录年度-周次映射关系
- **data_catalog.json**: 数据目录概览，包含文件路径和缺失周次信息

---

## 🗂️ 17个筛选维度字段中英文映射表

| 序号 | 中文字段名 | 英文字段名 | 数据类型 | 说明 |
|------|------------|------------|----------|------|
| 1 | 刷新时间 | snapshot_date | Date | 数据快照时间，格式：YYYY-MM-DD |
| 2 | 保险起期 | policy_start_year | Integer | 保单年度 |
| 3 | 业务类型 | business_type_category | String | 业务类型 |
| 4 | 成都中支 | chengdu_branch | String | 成都机构或异地机构 |
| 5 | 三级机构 | third_level_organization | String | 三级机构名称 |
| 6 | 客户类别3 | customer_category_3 | String | 客户类别 |
| 7 | 险种类 | insurance_type | String | 险种类别 |
| 8 | 交三/主全 | coverage_type | String | 险别组合 |
| 9 | 续保情况 | renewal_status | String | 新保转保续保 |
| 10 | 终端来源 | terminal_source | String | 投保终端 |
| 11 | 车险分等级 | vehicle_insurance_grade | String | 车险风险等级 |
| 12 | 高速风险等级 | highway_risk_grade | String | 高速公路风险等级 |
| 13 | 大货车评分 | large_truck_score | String | 大货车风险评分 |
| 14 | 小货车评分 | small_truck_score | String | 小货车风险评分 |
| 15 | 是否新能源车1 | is_new_energy_vehicle | Boolean | 是否为新能源车辆 |
| 16 | 是否过户车 | is_transferred_vehicle | Boolean | 是否为过户车辆 |
| 17 | 周次 | week_number | Integer | 数据对应的周次 |

### 布尔值映射规则
```python
BOOLEAN_VALUE_MAP = {
    '是': True,
    '否': False,
    'Y': True,
    'N': False,
    'true': True,
    'false': False
}
```

---

## 🧮 8个绝对值字段计算方法

### 保费类字段（单位：元）

#### 1. 签单保费 (signed_premium_yuan)
- **计算公式**: `跟单保费(万) × 10,000`
- **源字段**: signed_premium_10k
- **数据处理**: 万元转换为元，缺失值填充为0
- **精度控制**: 保留2位小数

#### 2. 满期保费 (matured_premium_yuan)
- **计算公式**: `满期净保费(万) × 10,000`
- **源字段**: matured_premium_10k
- **数据处理**: 万元转换为元，缺失值填充为0
- **精度控制**: 保留2位小数

#### 3. 商业险折前保费 (commercial_premium_before_discount_yuan)
- **计算公式**: `签单保费 ÷ 商业险自主系数` (仅适用于商业保险)
- **适用条件**: 险种类 = "商业保险" 且 商业险自主系数 > 0
- **数据处理**: 非商业险或系数无效时设为0
- **特殊处理**: 自主系数为0或空值时跳过计算

### 件数类字段（单位：件）

#### 4. 保单件数 (policy_count)
- **计算公式**: `签单保费 ÷ 单均保费`
- **数据处理**: 结果四舍五入取整，最小值为0
- **异常处理**: 单均保费为0时，保单件数设为0
- **精度控制**: 整数类型

#### 5. 赔案件数 (claim_case_count)
- **计算公式**: 直接使用源字段值
- **源字段**: claim_case_count_raw (案件数)
- **数据处理**: 缺失值填充为0，转换为整数类型
- **精度控制**: 整数类型

### 赔款类字段（单位：元）

#### 6. 已报告赔款 (reported_claim_payment_yuan)
- **计算公式**: `总赔款(万) × 10,000`
- **源字段**: reported_claim_payment_10k
- **数据处理**: 万元转换为元，缺失值填充为0
- **精度控制**: 保留2位小数

### 费用类字段（单位：元）

#### 7. 费用金额 (expense_amount_yuan)
- **计算公式**: `签单保费 × 费用率`
- **源字段**: expense_ratio
- **数据处理**: 费用率缺失时设为0
- **精度控制**: 保留2位小数

### 贡献类字段（单位：元）

#### 8. 满期边际贡献额 (marginal_contribution_amount_yuan)
- **计算公式**: `满期保费 × (边际贡献率 ÷ 100)`
- **依赖字段**: matured_premium_yuan, variable_cost_ratio
- **计算逻辑**: 边际贡献率 = (1 - 变动成本率) × 100
- **数据处理**: 变动成本率缺失时，边际贡献额设为0
- **精度控制**: 保留2位小数

---

## 🔧 数据质量保证

### 数据验证规则
1. **字段完整性检查**: 确保所有必需字段存在
2. **数据类型验证**: 验证数值字段的数据类型
3. **逻辑一致性检查**: 验证计算结果的合理性
4. **缺失值处理**: 统一的缺失值填充策略
5. **异常值检测**: 识别和处理异常数据

### 数据转换质量控制
- **单位统一**: 所有金额字段统一为"元"单位
- **精度控制**: 金额字段保留2位小数，件数字段为整数
- **布尔值标准化**: 统一布尔值表示方式
- **文本字段清理**: 去除前后空格，标准化文本格式

---

## 📊 使用建议

### 运行环境要求
- Python 3.8+
- pandas >= 1.3.0
- numpy >= 1.21.0

### 执行步骤
1. **准备数据**: 将Excel源文件放入`数据源/`目录
2. **运行脚本**: 执行`python 数据预处理脚本.py`
3. **检查输出**: 验证`car-insurance-dashboard/data/`目录下的输出文件
4. **查看报告**: 检查处理报告和元数据文件

### 最佳实践
1. **遵循计算原则**: 先聚合绝对值，再计算比率
2. **定期数据检查**: 使用内置的数据完整性检查功能
3. **监控处理日志**: 查看`data_restructure.log`了解详细处理过程
4. **备份重要数据**: 在处理前备份原始数据文件

### 故障排除
1. **检查源数据**: 确认数据目录存在且包含有效文件
2. **验证权限**: 确保输出目录有写入权限
3. **查看日志**: 检查详细错误信息和处理日志
4. **数据格式**: 验证输入数据的格式和字段名称

---

## 📈 输出数据使用指南

### 数据架构说明
- **筛选维度**: 17个字段
- **绝对值字段**: 8个字段

### 后续分析建议
1. **使用CarInsuranceCalculator**: 进行实时指标计算
2. **定期更新**: 保持数据的及时性和准确性

---